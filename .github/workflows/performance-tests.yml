name: API Performance
on: [push, pull_request]

jobs:
  performance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Flask and Test
        run: |
          # 1. Ustawienie ścieżek
          export PYTHONPATH=$GITHUB_WORKSPACE
          export FLASK_APP=app/api.py
          
          echo "Uruchamianie Flaska..."
          # 2. Start Flaska w tle, logi idą do flask.log
          python3 -m flask run --host=127.0.0.1 --port=5000 > flask.log 2>&1 &
          PID=$!
          
          # 3. Pętla oczekująca na start serwera (max 15 sekund)
          for i in {1..15}; do
            if curl -s http://127.0.0.1:5000 > /dev/null; then
              echo "Flask wystartował pomyślnie!"
              break
            fi
            echo "Czekam na Flaska... ($i/15)"
            sleep 1
            
            # Sprawdź czy proces nie umarł
            if ! kill -0 $PID 2>/dev/null; then
              echo "BŁĄD: Flask umarł przedwcześnie!"
              echo "=== LOGI FLASKA ==="
              cat flask.log
              exit 1
            fi
          done

          # 4. Jeśli po 15s nadal nie działa, pokaż logi i przerwij
          if ! curl -s http://127.0.0.1:5000 > /dev/null; then
            echo "TIMEOUT: Flask nie odpowiada."
            echo "=== LOGI FLASKA ==="
            cat flask.log
            exit 1
          fi

          # 5. Uruchomienie testów (tylko jeśli Flask działa)
          echo "Uruchamianie testów..."
          python3 -m pytest tests/perf
          TEST_EXIT_CODE=$?
          
          # 6. Pokaż logi Flaska na koniec (dla pewności) i zwróć wynik testu
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "Testy nie przeszły. Logi serwera:"
            cat flask.log
          fi
          exit $TEST_EXIT_CODE